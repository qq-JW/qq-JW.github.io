I"8<h1 id="汽车防盗系统一immo发动机防盗认证系统">汽车防盗系统：（一）IMMO发动机防盗认证系统</h1>

<h2 id="汽车防盗系统的发展历程">汽车防盗系统的发展历程</h2>

<p>从瓦特1757年发明蒸汽机，到奥拓1861年试制内燃机，再到卡尔·本茨造出第一台内燃机汽车，如今，汽车行业已经走过了近三百年，在早期，人类在汽车驾驶性能上所进行的研究要远远大于其他方面，而动力系统则是驾驶性能最重要的组成部分，毕竟如何让车“多快好省”地跑起来才是最实用的。正因如此，汽车行业的蓬勃发展使得有关内燃机的诸多实用技术层出不穷，涡轮增压、VVT、GDI、FSI等发动机技术也逐渐成为了发动机的标配，可即便如此，内燃机的热效率还是只有40%，却也几近极限。</p>

<p>市场决定一切，人们的需求决定着市场。随着发动机技术的成熟化，车厂也逐渐将目光转向新的领域，针对汽车动力系统的研究，也从内燃机这个最核心的动力部件，慢慢转移到新能源技术、混合动力技术，甚至纯电领域。20世纪末期到21世纪以来，随着微控制器、无线电技术等基础领域的长足发展，汽车电子逐渐盛行，越来越多的ECU，越来越庞大的整车CAN网络，都代表着更加安全、高效且智能的现代汽车。</p>

<p>汽车防盗系统早在民用汽车开始普及之时就开始产生：</p>

<ol>
  <li>
    <p><strong>摇摆钥匙</strong>：这可以说是钥匙的前身，它的盛行有两个原因：一是早期的发动机并没有电机带动，所以想要开始进行活塞运动，需要“手摇发动”；二是有电机带动并且配备电瓶的发动机在当时成本太高，无法被广泛使用。虽说是摇摆钥匙，但他更重要的功能显然是摇摆启动， 而非钥匙防盗。</p>
  </li>
  <li>
    <p><strong>机械钥匙</strong>：当电动机成本降下来后，更合理的机械钥匙才被广泛使用。这种钥匙就是一个电源开关，插进钥匙、转动，电路被接通，电动机带动发动机转动，汽车发动机被点火，反向旋转式钥匙复位，电动机停止转动。这种纯机械钥匙仅可以开关门和启动发动机，防盗功能有限，港片中常见的在方向盘下拉出两根线接通就是这个原理。然而现在的汽车钥匙内部都有芯片，已经不可能简单的靠接通“两根线打着汽车”了。</p>
  </li>
  <li>
    <p><strong>芯片钥匙</strong>：顾名思义，这种钥匙就是植入了一枚芯片，并且车载控制器加入IMMO防盗认证模块，当把钥匙插入点火锁中并拧到“ON”档，钥匙中的芯片会与BCM进行IMMO防盗认证，如果认证不通过，BCM将不会向发动机发出点火请求，也就无法启动汽车。所以这种钥匙的产生才真正意义上实现了汽车防盗的第二层—-发动机防盗，这导致你即使配了一把齿形相同的机械钥匙，打开了车门，也无法开走它，只能把车上的财物一扫而空，很是遗憾。再到了后来，人们的便利性智能性需求使得<strong>芯片+遥控器/芯片遥控器</strong>一体应运而生，这种钥匙将解闭锁从手动拧钥匙变换为遥控控制，但仅仅是便利性得到提升，点火也必须使用机械钥匙，防盗安全性其实与单纯芯片钥匙并无区别。</p>
  </li>
  <li>
    <p><strong>智能钥匙</strong>：随着PEPS系统的日渐成熟，这种钥匙不仅外形上舍弃了之前的机械钥匙刀头，RKE、PKE以及一键启动功能的实现也让解锁-起步的整个过程科技感十足，不过由于保险起见，大部分智能钥匙内部还是会隐藏一把机械钥匙。</p>

    <p>目前针对大多数车企，现代民用汽车成熟的防盗系统主要是由两部分完成—-解闭锁的钥匙防盗和启动时的发动机防盗，钥匙防盗由机械进化为芯片，启动防盗则是随着IMMO防盗技术的发展不断演变，而ESCL电子转向锁则是介于两种防盗之间空白地带的第三重保障。</p>

    <p>本文首先针对IMMO技术进行学习。</p>
  </li>
</ol>

<h2 id="immo发动机防盗认证系统">IMMO发动机防盗认证系统</h2>

<p>IMMO，全称“Immobilizer”，是一种直接针对汽车动力系统的防盗认证系统，最初的IMMO防盗模块拥有独立式的防盗模块，IMMO利用无线电技术在动力控制器、钥匙芯片和BCM之间进行防盗密码的一系列传输、计算和认证，从而判断是否允许启动汽车动力系统，对于燃油车而言BCM发送启动信号给EMS（发动机控制单元），对于纯电汽车则是PEU（电机控制器），目前有很多主机厂将IMMO集成在BCM或拥有PEPS的控制器中，省去一个模块的同时安全性能也有所提高，这也是机械钥匙进化为芯片钥匙后出现的对于汽车防盗安全性的巨大提升。下文将介绍的就是目前较为智能的集成在拥有PEPS的控制器中的IMMO防盗认证系统。</p>

<p>IMMO认证分为前后两级认证，通俗来说，就是当你插入钥匙转动后整车除了发动机大部分电器都被点亮时，你完成了前级认证，而当你踩下刹车继续转动钥匙到发动机启动时，你完成了前级和后级认证。</p>

<h3 id="step-1-immo前级认证"><em>Step 1： IMMO前级认证</em></h3>

<p>IMMO前级认证指的是Transponder钥匙与PEPS之间的认证，点火开关状态为OFF/ACC到ON档、OFF/ACC到START均会触发此认证系统，认证算法为HITAG 3。</p>

<h4 id="前级认证流程">前级认证流程</h4>

<ol>
  <li>旋转钥匙至ON档</li>
  <li>钥匙认证次数的计数器加1；</li>
  <li>PEPS 发送” 开始认证”命令给钥匙；</li>
  <li>钥匙收到PEPS的请求后，将”KEY ID”发给PEPS；</li>
  <li>PEPS 收到”KEY ID”后，将随机数” Random Data”和加密结果”Signature”发送给钥匙，并计时T(T=30 ms)</li>
  <li>钥匙收到后验证计算结果是否一致：
    <ul>
      <li>一致：将加密后的数据”RES Data”反馈给PEPS；</li>
      <li>不一致：不回复加密结果给PEPS,执行8；</li>
    </ul>
  </li>
  <li>T内，PEPS 接收到钥匙反馈的”RES Data”，判断”RES Data”是否一致：
    <ul>
      <li>一致：钥匙认证成功，更新如下周期信号：
        <ul>
          <li>‎PEPS发送IMMOIndicator= 0；给IPK；</li>
        </ul>
      </li>
      <li>不一致：判断钥匙认证次数：</li>
      <li>若＜3次，返回2；</li>
      <li>若≥3次，钥匙认证失败，PEPS反馈认证失败</li>
    </ul>
  </li>
  <li>T超时，判断钥匙的认证次数：
    <ul>
      <li>若＜3次，返回2；</li>
      <li>若≥3次，钥匙认证失败，PEPS反馈认证失败</li>
    </ul>
  </li>
</ol>

<h3 id="step-2-immo后级认证"><em>Step 2：	IMMO后级认证</em></h3>

<p>IMMO后级认证指的是动力防盗认证功能，如果PEPS对钥匙的认证成功，则BCM将等待EMS发出的挑战。如果挑战的编码是正确的，那么BCM将对此挑战向EMS发送一个有效的响应。反之，BCM将发送错误的响应。当EMS配置不必动力防盗认证时，EMS始终发送IMMOAuthenticationStatus= Success。当动力系统模块，收到CAN信号system power mode变为RUN时。EMS、VMS或HCU必须开始向BCM发送有效的挑战。然而，CAN总线断开或CAN报文丢失通讯的情况下，当电源输入有效时，EMS、VMS或HCU必须开始向BCM发送有效的挑战。 “远程启动”这种特殊情况下，CAN信号和电源输入不一致， EMS、VMS或HCU不必向BCM发送有效的挑战。</p>

<h4 id="认证过程">认证过程</h4>

<p>钥匙认证通过后，BCM等待EMS发出挑战。只要EMS向BCM发送挑战，如果挑战的编码是有效的，那么BCM将对此挑战向EMS发送一个有效的响应。如果挑战的编码无效，BCM将发送错误的响应。如果BCM对钥匙的认证不成功，BCM将不会响应EMS的挑战。整个认证过程分为EMS和BCM两个过程：</p>

<h4 id="ems认证">EMS认证</h4>

<p>EMS应该在“System Power mode=RUN”后200 ms内向BCM发出挑战。</p>

<p>a） 如果BCM没有响应，EMS将在2 s内的每隔150 ms发送一条相同的消息（相同的随机码），如果在2.1s内没有响应，则EMS认为认证失败。</p>

<p>注：如果BCM没有响应挑战，则在0毫秒、150毫秒、300毫秒、450毫秒、600毫秒、750毫秒、900毫秒、1050毫秒、1200毫秒、1350毫秒、1500毫秒、1650毫秒、1800毫秒、1950毫秒发送相同的挑战（相同的随机码），最后一次发出挑战后，EMS将等待响应至2.1秒（1950毫秒+150毫秒）。</p>

<p>b） 在EMS发出挑战后，如果EMS从BCM接收到无效响应或BCM无响应挑战，只要2s窗口时间未过期，且总体无效响应不超过3次，则EMS将在150 ms后重试发起挑战。</p>

<p>c） 在EMS发出挑战之后，如果在2 s窗口时间内EMS收到BCM回复的一个有效的响应，则认为认证成功。否则，如果在2 s窗口时间内没有收到BCM的有效响应，或者无效响应总数大于3次，则认为认证失败并发送失败信号给BCM。</p>

<p>d） 如果EMS和BCM之间的验证失败，则不再需要每隔6 s在EMS和BCM之间进行定期身份验证。如果EMS是初始为学习状态（即EMS没有SK和/或PIN），EMS不应向BCM发送任何挑战消息。</p>

<h4 id="bcm认证">BCM认证</h4>

<p>在收到“认证挑战”后，challenge和SK应由函数function XX处理解码，并将解码结果与BCM中存储的PIN进行比较。</p>

<ul>
  <li>如果PIN匹配，那么BCM反馈“认证通过的”响应。BCM应该使用和EMS相同的64位的密钥来来解码EMS发送过来的随机码。</li>
  <li>如果PIN不匹配，那么BCM将反馈“认证失败”响应（一个64位全“F”数字）。如果一级钥匙无效，则BCM回复一个64位全“0”数字。如果PIN和随机数都匹配相同，则认为相互设备身份验证成功。</li>
</ul>

<p>注意：EMS将确认从BCM反馈中解密的PIN，由于解码函数function XX在当前应用中的使用方式，BCM使用的随机变化不会导致EMS计算的PIN发生变化。因此，EMS应该同时检查PIN和随机数计算。</p>

<p>如果收到的PIN码是全“FF”或“00”，或者PIN不相同，则计数器加1。如果在2 s内错误计数器小于3次，则EMS在2 s内每150 ms发送一条相同的消息(使用不同的随机码)，如果错误计数器等于3次，则认为认证失败。当发生新的身份验证周期时，计数器设置为零。BCM在任何时候要响应EMS发送的动力防盗挑战，除非发动机防盗锁止身份验证失败。</p>

<h3 id="通俗解释">通俗解释</h3>

<p>上车后，旋转机械钥匙至RUN档，PMM变为RUN时，EMS开始发送challenge给BCM，IMMO钥匙认证正式开始，首先钥匙会发送一个加密的keyID给IMMO，这个过程称为钥匙的效验工程，如果两者不匹配，那就没有后面的事了。此时:</p>

<ul>
  <li>BCM如果IMMO还在认证中，尚未认证结束。BCM不响应challenge。150 ms后EMS会retry新的challenge。BCM需要根据新的challenge做出反馈。</li>
  <li>IMMO如果已经认证完成且结果是认证时通过的。BCM需要根须EMS的challenge做出反馈。</li>
  <li>如果已经认证完成且结果是不通过的。BCM需要根须EMS的challenge做出反馈全FF。</li>
</ul>

<h2 id="总结">总结</h2>

<p>当我拿着一把街边小摊配的机械钥匙成功打开车门并甚至插进钥匙孔转动成功上电时，我一度认为这与备用钥匙外观并无差异的无芯片钥匙可以以假乱真。</p>

<p>当我踩下刹车继续旋转钥匙启动发动机失败，并且“立刻”换了备用钥匙依然无法上电时，我又一度认为这台车在短短的一个周末一定出了其他的问题。而著名侦探老秦曾经说过：当排除了所有可能，剩下的那个就算再不可能，也一定是真相。</p>

<p>但有时候如果你采用反常规操作，那问题出现的逻辑也会一样让人大跌眼镜，那就是：</p>

<ul>
  <li>
    <p>其实外表LOW到和机械钥匙长相无异的备用钥匙，也是有芯片的。</p>
  </li>
  <li>
    <p>备用钥匙明明之前还可以启动，现在却也失效的问题就在“立刻”二字。</p>
  </li>
  <li>
    <p>IMMO防盗在OTS车一般是关闭的但这辆车只有BCM关闭了而PEU开着。</p>
  </li>
  <li>
    <p>更巧的是如果BCM和PEU防盗都打开的话就连ON档我都上不去，可偏偏这辆车BCM防盗未开。</p>
  </li>
</ul>

<p>谨以此文章，纪念我失去的钥匙。</p>

<h2 id="相关说明">相关说明</h2>

<h3 id="缩写表">缩写表</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: left">英文缩写</th>
      <th style="text-align: center">英文原意</th>
      <th>中文含义</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">IMMO</td>
      <td style="text-align: center">Immobilizer</td>
      <td>防盗单元</td>
    </tr>
    <tr>
      <td style="text-align: left">PEPS</td>
      <td style="text-align: center">Passive Entry Passive Start</td>
      <td>无钥匙进入及启动系统</td>
    </tr>
    <tr>
      <td style="text-align: left">BCM</td>
      <td style="text-align: center">Body Control Module</td>
      <td>车身控制模块</td>
    </tr>
    <tr>
      <td style="text-align: left">IPK</td>
      <td style="text-align: center">Instrument Package Module</td>
      <td>仪表盘模块</td>
    </tr>
    <tr>
      <td style="text-align: left">RKE</td>
      <td style="text-align: center">Remote Keyless Entry</td>
      <td>遥控无钥匙进入</td>
    </tr>
    <tr>
      <td style="text-align: left">PKE</td>
      <td style="text-align: center">Passive Keyless Entry</td>
      <td>被动无钥匙进入</td>
    </tr>
    <tr>
      <td style="text-align: left">EMS</td>
      <td style="text-align: center">Engine Management System</td>
      <td>发动机管理模块</td>
    </tr>
    <tr>
      <td style="text-align: left">ESCL</td>
      <td style="text-align: center">Electric Steering Column Lock</td>
      <td>电子转向柱锁</td>
    </tr>
  </tbody>
</table>

<h3 id="参考文献">参考文献</h3>

<p>IMMO认证规范</p>
:ET
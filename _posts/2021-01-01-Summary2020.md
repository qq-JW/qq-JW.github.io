---

layout: post
title: "2020总结"
date: 2021-01-01
tag: 笔记


---

2020，是我在技术中心的第二个年头，这一年从工作内容上来说，可以很鲜明地分为2个阶段，5月之前单件ECU的网络诊断测试和之后的整车集成测试，虽然工作的内容和状态截然不同，但却没有很强的隔离感，现在回过头看，这两者在某种程度上来说还真有一种相辅相成的感觉。

网络诊断测试让我在刚进入汽车行业就接触到整车各式各样的控制器实体，他们散落在车身的各个部位，组成整车CAN网络并互相通信，通过报文完成了汽车绝大部分的功能，这是普通消费者在面对一台汽车时根本无法触及的东西，ECU单件测试的核心内容是针对整车CAN网络中不同零件之间在微观通信上的表现进行评判，这些看似细枝末节的东西却也是CAN（Controller Area Network）的核心所在，而整车集成测试则是站在普通消费者的角度，宏观地从对某一系统进行基本功能检查，这就好比外科医生在看病时，对表征病情的望闻问切与CT和B超等一系列深入探究病理的检查之间的区别。

而HIL台架测试的相关工作，则这又是另一个维度的测试领域，通过台架仿真整车关键控制器及信号，对真实被测件（BCM和FICM）进行硬件在环的自动化功能测试，可以弥补实车测试成本高昂、开发前期测试资源不足及手动很难完成的压力测试等，数以千计的自动化测试脚本可以节省大量的人力成本。

------

### 网络诊断测试

最初的2个月，主要是在各个培训中辗转，熟悉整车CAN网络，了解CVTC公司商用车开发流程，读懂网络拓扑图中的每条CAN线上的ECU等等，这都对以后的工作有很大的辅助作用。短暂的入职培训后，就进入网络诊断实验室开始进行测试工作。网络诊断测试共分为3大部分测试内容，分别为网络测试、诊断测试和刷写测试，其中网络测试又包含网络管理测试和网络通信测试，网络管理根据不同ECU网络管理的不同方式又分为间接网络管理和直接网络管理。在实际中，部分供应商诊断功能未开发完全的，可先进行网络通信和刷写的基本测试。

##### 网络诊断

网络诊断测试，所有的电控单元都应具备诊断功能。诊断功能包含内部诊断功能和服务处理功能。内部诊断功能即为电控单元初始化或关闭时的故障自检测和连续故障自检测；服务处理功能则有诊断故障代码获取、输入/输出控制、安全访问、数据获取、程序控制、刷新等。没有电控单元应用功能的支持，大部分诊断功能将无法起作用，即诊断服务需要电控单元内提供特定的功能。反之亦然，在某些情况下，诊断功能可能会被应用功能限制。例如，为确保安全和防止输入/输出控制服务时的零件损坏，电控单元应执行必要的限制。

最初，大量的工作内容集中在将一份份诊断规范转化为可执行自动化测试的诊断数据库上，这样的数据库在CANOE工具链中称为“CDD”，现在看来，闷头做似懂非懂大大小小的cdd将近30份，才真正了解诊断工作的内涵。CDD作为诊断自动化测试的配置文件，其质量对测试结果起着尤为重要的作用。

CANdelaStudio用于定义ECU的诊断需求，生成诊断数据库（CDD/ODX）,优化整个诊断开发过程。CANdelaStudio支持文档模板（CDD文件），一个文档模板对应于一种诊断规范，它包含了ECU所有允许的基本服务和在每个ECU中都必须实现的强制功能的一个正式描述。

CANoe.DiVa是CANoe的一个功能扩展包，能根据ECU的诊断数据库文件自动生成测试用例。这些用例能直接导入CANoe中执行。

一般来说，ECU上电后正常通信，需要进行准入冒烟测试，包括正向刷写、会话切换、物流数据读取等没有严重问题后，即可开始自动化测试。CANOE.DIVA用来完成网络诊断测试的自动化过程，自动化测试的配置过程比较简单，难点主要在于分析测试的结果，需要对现有的诊断规范比较熟悉，对各类诊断服务有基本的认识，并且问题来源是cdd、诊断规范还是确实是软件的BUG，需要对照报文、诊断规范和各种标准进行核对。

##### 网络通信

网络通信测试，主要是对ECU在物理层、数据链路层及交互层的表现进行评估，包括供电电压、物理层总线电平及位时间测试、交互发送行为及报文信号格式测试、网络相关诊断等方面。这部分测试内容原理和操作都比较好上手，其中网络相关诊断的测试中有关停止/恢复电压和节点超时评估等是诊断服务的基础。

##### 网络管理

CAN网络管理描述了CAN网络的状态转换、网络开启/关闭过程的需求。针对一类ECU和二类ECU分别需要间接和直接的网络管理方式去实现控制器的休眠唤醒。

对于间接网络管理的电控单元，由于点火钥匙已经关闭，其处于网络非激活状态下，并不具备任何功能，测试项较为简单，主要分析上KL15电后报文的初始帧时间、可接受报文时间，下15电后报文停发时间等参数，保证DUT能够正常完成状态转换即可。

而直接网络管理的ECU，则是对网段中所有参与的电控单元，使用令牌环机制建立一个逻辑环，以达到同步关闭一个CAN网段中的所有电控单元的目的。目前主流的有OSEK网络管理和AUTOSAR网络管理方式。在OSEK中，需要清楚网络管理报文含义，建环、节点状态转换、睡眠等相关机制的内在逻辑，各ECU的睡眠条件，唤醒条件等，在AutoSAR中其实所需要的输入也基本一致，只不过采用的管理方式和状态跳转条件不同罢了。

##### 网络刷写

刷写测试，则是保证产线或售后刷新和升级软件的测试，包括应用软件和标定数据，都需要按照企标的标准流程统一刷写规范。企标对刷写软件的格式，物流数据的更新都有明确的规定。刷写需要用到的诊断服务有$34，$36，$37，$22，$2E等，按照一定流程组成刷写软件的整个过程。测试所需要做的，就是测试在各种极端条件下，比如历程擦除前中断电源，传输数据过程中中断等，ECU是否还能保持正常的基本刷新功能，毕竟，么的软件的硬件，么的灵魂。

------

### HIL

硬件在环测试，顾名思义，是要保证整个环路除了被测件以外，均为仿真信号的测试。

HIL实现自动化测试，可以提升测试效率，仿真虚拟对手件模型，仿真CRC等算法，支持碰撞、档位、轮速等需要进行校验的信号测试，提高测试覆盖度，基于信号级测试，问题定位更精准，实现故障及诊断类测试，提前发现问题，降低后期整改成本。而其难点则表现在需求变化快，平台化困难。涉及专业面广泛，工具链复杂上。

这是一个综合性很强的岗位，可以说，学计算机、发动机、车辆工程、自动化仿真的专业，都可以来做HIL，但又可以说这些人都无法直接做HIL，因为这个岗位包含的知识是需要积累和沉淀才能达到的，简单来说只要供应商搭好台架，建立好工程，甚至激励好基本功能，我们只需要根据SSTS逻辑编写测试脚本就可以了，但除了基本的问题管理和推进，HIL还需要熟悉大量相关工具链，具备自动化测试工程搭建能力、模型开发仿真能力、模块化函数库开发能力、脚本开发能力、还要至少了解模拟电路数字电路、以及各类规范协议国标等，任何一个细节都会导致测试无法执行下去。

复杂，多元，可扩展性强，这是HIL另类的优点，也是吸引我的地方，它符合我想发展成多元的技术人员的需求，也是未来测试的方向，就像自动驾驶是未来驾驶的方向，自动测试也是未来测试的方向。

我所接触的HIL测试主要分为车身电子和娱乐两大内容，其中车身电子是对BCM这一控制器进行在环测试，而娱乐系统则是利用机械臂代替人手，完成人在车上进行操作的测试。刚来到单位，我学开发流程、学车辆ECU、接触到网络层和应用层的诊断规范、网络管理等，虽然我见过他们每一个控制器的实体，但依然觉得抽象无比，因为我并不了解他们的对手件，甚至不了解他们在车上的具象功能，安装位置，后来我接触车身、进行实车测试，了解一个BCM，就了解了整个车上的大部分功能，这也是为什么车身的HIL主要是围绕BCM来展开的，各个子系统，各个SSTS都让我痴迷，我学每个子系统，去车上看每个子系统的功能，一一验证，不同平台、不同配置，不同差异，而且可以把之前的网络知识在实车运用，这是件很爽的事。搭建HIL台架，了解信号特性、拉出每一个信号，激励每一个功能，在闭环系统上实现我在车上的功能，这又是一种新的体验。接下来漫长的时间就是对着规范，把ssts转化为一条一条的用例，这个过程很煎熬，但很值得。

------

2020，如上，2021，继续。。。
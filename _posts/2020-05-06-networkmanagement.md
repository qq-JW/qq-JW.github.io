---

layout: post
title: "初识网络管理"
date: 2020-05-06
tag: CAN


---

### 什么是网络管理？

CAN网络管理描述了CAN网络的状态转换、网络开启/关闭过程的需求。网络管理可以保证网络同步进入睡眠状态，监控网络状态信息，以及对网络故障进行处理。

### 为什么需要网络管理？

1. 随着车上ECU数目越来越多，不同的ECU对于电源模式的需求不同，需要网络管理进行协调。
2. 需常供电的ECU存在静态电流损耗，需要有进入低功耗模式的条件和管理方式，不同ECU的睡眠条件也不同。

一般来说，根据电控单元是否需要在点火钥匙KL15 OFF后工作，CAN网络中的电控单元可分为两类：

- I类：只在点火钥匙KL15 ON时支持CAN通讯的电控单元，例如：EMS，TCU，ABS等。
- II类：在点火钥匙打开和关闭（KL15 ON和KL15 OFF）时均需保持CAN通讯以支持其功能的电控单元，例如：BCM、IPK。

### 网络管理的分类

根据ECU所需电源模式的不同，CAN网络管理被分为间接网络管理和直接网络管理。

I类控制器通过间接网络管理对网络进行启动和关闭，此类控制器只在KL15电时工作，通过点火钥匙旋转或SSB开关下15电后，无论是否还有30电，均需停止工作或在一定时间内停发报文。因此，此类ECU网络管理逻辑较为简单，只可本地事件激活，无法被远程事件唤醒，断开KL15电后不会发出，也不会回应各类远程报文。

II类控制器在KL15下电后依然需要继续工作，此时电控单元根据自身情况决定是保持在本地模式还是进入低功耗模式，在本地模式下，电控单元可执行那些不需要CAN通信的功能。在低功耗模式下，电控将禁止所有功能，同时进入低功耗模式。

由于需要ECU根据自身情况和网络中的报文情况决定是否进入睡眠模式，所以各个ECU的睡眠模式各不相同，需要一个统一的方式去管理，这就是间接网络管理，目前主流的间接网络管理有OSEK/VDX网络管理和AutoSAR网络管理。

OSEK网络管理使用令牌环机制，令牌从网络地址低的节点传到网络地址高的节点，如果没有更高的节点，就传给最低地址节点。令牌环根据ECU的网络地址建立。每个ECU都会接受网络管理消息，只有和目的地址相同的一个节点才会得到令牌。根据此机制，可同步管理网络上的所有ECU进入睡眠模式或唤醒状态，但也正是由于环状通信模式的存在，使得睡眠行为和节点异常都需要整个令牌环上所有ECU进行回复和接受，策略相对复杂。

AutoSAR则基于分布式策略，每个节点根据通信系统中发送或者接收到的NM消息来执行自给自足的网络活动。每个ECU自己广播出自己的网络管理帧，也接收只属于自己的NM报文，网络激活或睡眠的行为完全由自身收到的NM和本地唤醒源控制，相对比较简单而被广泛应用。

